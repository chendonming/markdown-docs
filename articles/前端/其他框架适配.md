# BimViewer JavaScript 库使用文档

## 1. 简介

`BimViewer` 是一个 JavaScript 库，它封装了 `BIMWIN-CORE` BIM Web SDK (`PIT.umd.js` 和相关组件，如 `pit-bim-win-ui`, `pit-bim-win-dialog`)。本库的主要目标是简化将 PIT BIM 查看器集成到 Web 应用中的过程，特别是对于：

- **非 Vue.js 项目：** 如使用 React、Angular 或原生 JavaScript 的项目。
- **需要程序化控制：** 在 Vue.js 项目中，如果希望通过 JavaScript API 而不是模板来动态控制查看器、对话框和插槽。

`BimViewer` 提供了一个面向对象的接口，用于初始化查看器、处理配置、管理对话框、动态设置插槽内容以及监听查看器事件。

## 2. 快速入门

以下是一个最基本的使用示例，用于在页面上渲染 BIM 查看器：

**HTML:**

```html
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>BimViewer 快速入门</title>
    <!-- 1. 引入 PIT 样式 -->
    <link rel="stylesheet" href="./lib/PIT.css" />
    <style>
      #viewer-container {
        width: 800px;
        height: 600px;
        border: 1px solid #ccc;
        position: relative; /* 建议，用于定位内部元素 */
      }
    </style>
  </head>
  <body>
    <h1>BimViewer 示例</h1>
    <div id="viewer-container"></div>

    <!-- 2. 引入依赖库 (Vue 和 PIT SDK) -->
    <script src="https://unpkg.com/vue@2.6.10/dist/vue.min.js"></script>
    <script src="./lib/PIT.umd.js"></script>

    <!-- 3. 引入 BimViewer 库 -->
    <script src="./BimViewer.js"></script>

    <script>
      // 4. 获取容器元素
      const container = document.getElementById("viewer-container");

      // 5. 配置 BimViewer (最简配置)
      const config = {
        url: "YOUR_API_BASE_URL", // 替换为您的 PIT API 基础 URL
        fileId: "YOUR_FILE_ID", // 替换为要加载的文件 ID
        viewToken: "YOUR_VIEW_TOKEN", // 替换为有效的视图 Token
        // 或者使用 headers.token: "Bearer YOUR_TOKEN"
      };

      // 6. 创建 BimViewer 实例
      const viewer = new BimViewer(container, config);

      // 7. 等待查看器准备就绪
      viewer.ready
        .then((vueOptions) => {
          console.log("BIM 查看器已准备就绪！", vueOptions);
          // 可以在这里执行与查看器交互的操作
        })
        .catch((error) => {
          console.error("BIM 查看器初始化失败:", error);
          // 可以在这里处理初始化错误，例如向用户显示消息
        });
    </script>
  </body>
</html>
```

**Vue3**

```js
import BimViewer from "bimviewer";
import "bimviewer/dist/PIT.css";

onMounted(() => {
  const viewer = new BimViewer("#bimwin", {
    fileId: "1909440321659985920",
    viewToken:
      "Bearer eyJraWQiOiJjODRhOTUxYWZjZTBiNmE0ZGU2N2Q5NmViMjM2MjJlZSIsImFsZyI6IlJTMjU2In0.eyJzdWIiOiJhZG1pbiIsImF1ZCI6ImJpbXdpbi1jbG91ZCIsIm5iZiI6MTc0NDkzOTMyNywic2NvcGUiOlsib3BlbmlkIl0sImlzcyI6Imh0dHA6Ly8xMjcuMC4wLjE6ODc4OCIsImV4cCI6MTc0NDk4MjUyNywiaWF0IjoxNzQ0OTM5MzI3fQ.n9rtNt9FlEhxuySz7mkaiJQOvxlPHIzPFBtp8zTcWKZgfQShBqij34M83Lb3dssTD_lfvhfGVANUSrNQKA_Suj3OabAOU4OC6rvXbe2QCl1cbcS488VTiOs_BYeB7WZva-ZAROPK-T10jmt1gYcsDsZke_erKb94jxHN1nWMHfTcTjRgUyEZomnqnnbdcOorLbRU5VFjsSW9Omxgj470FBfaP1ZWw4zcRPt3AM4BtvQxOhFcZ-EARqIT5_t7kmcIEb57aF_6xFcJjaV-dCkdMBFNio8jh3p0zcI1-3coaNd135U8uBIhudrEvK4MmXGE4ZRkmKyLx4H2mc6kMs5bFg",
    url: "http://172.18.3.55:18181/",
    lod: true,
    appStyle: "light",
    appProps: {
      visibleToolbar: [
        "currentMainPerspective",
        "resetMainPerspective",
        "directoryTree",
      ],
    },
  });

  viewer.ready.then((options) => {
    console.log("Viewer 1 Ready, Vue Options:", options);

    viewer.setSlotContent("annotationInput", dialog.value, (props) => {
      console.log(props);
    });

    viewer.on("onPickPoint", (e) => {
      console.log(e);
    });
  });
});
```

**说明:**

1.  **引入 CSS:** 必须引入 `PIT.css` 以确保样式正确。
2.  **引入 `BimViewer.js`:** 引入我们构建的库文件。
3.  **获取容器:** 需要一个页面上已存在的 DOM 元素作为查看器的挂载目标。
4.  **配置:** 提供最基本的配置，包括 API 地址、文件 ID 和身份验证 Token。
5.  **实例化:** 使用 `new BimViewer(container, config)` 创建实例。
6.  **等待 `ready`:** 初始化过程是异步的（可能需要获取数据）。必须使用 `viewer.ready` Promise 来确保查看器完全加载并渲染完成后再执行后续操作。`.catch()` 用于捕获初始化过程中可能发生的错误。

## 3. 依赖项

- **bimviewer**包括了依赖的**vue2**和**PIT.umd.js**,无需处理其他依赖

## 4. 初始化 (`new BimViewer`)

通过 `new BimViewer(domTarget, userConfig)` 创建实例。

- `domTarget` (Element|string): **必需**。一个页面上已存在的原生 DOM 元素或者可以被`querySelector`调用的 dom 字符串，BIM 查看器将被渲染到这个元素内部。
- `userConfig` (Object): **必需**。一个包含配置选项的对象。

## 5. 配置选项 (`userConfig`)

`userConfig` 对象用于定制 `BimViewer` 的行为和外观。以下是一些常用选项（完整列表请参考 `BimViewer._defaultConfig`）：

**核心配置:**

- `url` (string): **必需**。PIT API 的基础 URL。
- `fileId` (string | Array): **必需 (除非使用 `previewID`)**。要加载的单个文件 ID (字符串)，或在特定模式（如叠图、地图）下使用的文件 ID 数组或对象结构。
- `previewID` (string | null): **可选**。如果提供，将优先于 `fileId`，用于加载预览模型。此时通常不需要手动提供 `viewToken`，库会尝试自动获取。
- `viewToken` (string | null): **必需 (除非使用 `previewID` 或公共访问)**。用于 API 请求的身份验证视图 Token。**推荐优先使用此项传递 Token。**
- `headers` (Object): **可选**。自定义请求头。如果同时提供了 `viewToken` 和 `headers.token`，`viewToken` 的优先级更高（但最终都会设置到 `headers.token`）。默认包含 `loginMark`。
  - `token` (string): 也可以在这里设置 Token，例如 `headers: { token: 'Bearer YOUR_TOKEN' }`。

**功能与特性:**

- `isCombine` (boolean): 是否为合并模型 (通常由 `previewID` 或文件类型自动判断，也可手动指定)。默认为 `false`。
- `stackedDiagram` (boolean): 是否启用叠图模式。默认为 `false`。启用后，`fileId` 应为叠图的基础 ID，库会请求详细信息并处理文件列表和变换。
- `longitude` (number | null): **可选**。启用地图模式并设置中央经线（整数）。如果设置，库会自动处理 `fileId` 格式以适应地图模式（除非同时启用了 `stackedDiagram`）。
- `mapImageryUri` (string): 地图模式下的影像服务 URI 模板。
- `mapImageryName` (string): 地图模式下的影像服务名称。
- `enableAo` (boolean): 是否启用环境光遮蔽 (Ambient Occlusion)。默认为 `true`。
- `lod` (boolean): 是否启用 LOD (Level of Detail)。默认为 `false`。
- `progressRender` (boolean): 是否启用进度渲染效果。默认为 `false`。
- `appProps`(Object): 原`pit-bim-win-ui`组件中的 Props。
- `platformConfig`(Object): platform 中的参数，可以被此参数覆盖。

**外观与调试:**

- `appStyle` (string): UI 样式主题 (例如 'default', 'dark', 'light')。默认为 `'default'`。
- `background` (string | null): 设置查看器背景色。默认为 `null` (由 PIT 内部决定)，叠图模式下默认为 `'#292d2e'` (除非手动覆盖)。
- `showTitle` (boolean): 是否显示模型标题。默认为 `true`。
- `debugUI` (boolean): 是否显示调试 UI。默认为 `false`。

**其他:**

- `apiVersion` (number): 使用的 API 版本。默认为 `3`。
- `libsPath` (string): PIT 依赖库（如 WebAssembly 文件）的路径。默认为 `'./lib/'`。

## 6. 异步初始化 (`viewer.ready`)

`BimViewer` 的初始化涉及异步操作（如获取 Token、文件信息）。因此，不能在 `new BimViewer()` 之后立即与查看器交互。

您**必须**使用返回的 `viewer` 实例上的 `ready` Promise 来确定初始化是否完成：

```javascript
const viewer = new BimViewer(container, config);

viewer.ready
  .then((vueOptions) => {
    // 成功回调
    console.log("查看器已准备就绪");
    // vueOptions 包含了最终传递给内部 Vue 实例的数据
    // 可以在这里安全地调用 viewer 的其他方法，如 showDialog, setSlotContent, on 等
  })
  .catch((error) => {
    // 失败回调
    console.error("初始化失败:", error);
    // 处理错误，例如显示错误消息
  });
```

## 7. 显示对话框 (`showDialog`)

`BimViewer` 允许您在查看器之上显示包含自定义内容的模态对话框。

- **`viewer.showDialog(dialogConfig)`**
  - `dialogConfig` (Object): 对话框配置对象。
    - `contentElement` (Element): **必需**。要在对话框主体中显示的原生 DOM 元素。
    - `title` (string): **可选**。对话框标题。默认为 `'对话框'`。
    - `style` (Object): **可选**。应用到对话框根元素的 CSS 样式对象。
    - `closeOnClickModal` (boolean): **可选**。点击遮罩层时是否隐藏对话框。默认为 `false`。
    - `showClose` (boolean): **可选**。是否显示右上角的关闭按钮（点击隐藏）。默认为 `true`。
    - `width` (string): **可选**。对话框宽度。默认为 `'50%'`。
    - `height` (string): **可选**。对话框高度。默认为 `'auto'`。
    - `top` (string): **可选**。对话框距离视口顶部的距离。默认为 `'15vh'`。
    - `props` (Object): **可选**。传递给内部 `pit-bim-win-dialog` 组件的其他 props。
  - **返回值:** (Object) 一个包含控制方法的对象：
    - `id` (string): 对话框的唯一内部 ID。
    - `show()` (function): 显示（如果之前被隐藏）此对话框。
    - `hide()` (function): 隐藏此对话框（不销毁）。
    - `destroy()` (function): 隐藏并彻底销毁此对话框实例。

**示例:**

```javascript
viewer.ready.then(() => {
  // 1. 创建内容元素
  const dialogContent = document.createElement("div");
  dialogContent.innerHTML = `
        <p>这是一个自定义对话框。</p>
        <button id="dialog-close-btn">关闭我</button>
    `;

  // 2. 显示对话框并获取控制器
  const dialogController = viewer.showDialog({
    contentElement: dialogContent,
    title: "我的对话框",
    width: "300px",
  });

  // 3. (可选) 从内部关闭
  dialogContent.querySelector("#dialog-close-btn").onclick = () => {
    dialogController.hide(); // 或者 dialogController.destroy();
  };

  // 4. (可选) 稍后隐藏或销毁
  // setTimeout(() => dialogController.hide(), 5000);
  // setTimeout(() => dialogController.destroy(), 10000);
});
```

## 8. 动态设置插槽内容 (`setSlotContent`)

允许您在 `BimViewer` 初始化后，动态地将自定义的原生 DOM 元素注入到 `pit-bim-win-ui` 组件的指定插槽中，并处理作用域插槽的 props。

- **`viewer.setSlotContent(slotName, element, propsCallback)`**
  - `slotName` (string): **必需**。目标插槽的名称 (例如 `'annotationInput'`)。
  - `element` (Element | null): **必需**。要放入插槽的原生 DOM 元素。传入 `null` 可以清空插槽。
  - `propsCallback` (function | null): **可选**。当 `pit-bim-win-ui` 向此插槽传递 props 时调用的回调函数。该回调会接收一个参数：`slotProps` 对象。

**示例 (结合 Vue 3):**

```vue
<script setup>
import { ref, onMounted, nextTick } from "vue";
import BimViewer from "./BimViewer.js";

const viewerContainer = ref(null);
const viewerInstance = ref(null);
const annotationDialog = ref(null); // ref 指向 Vue 3 模板中的 div

onMounted(() => {
  const viewer = new BimViewer(viewerContainer.value, {
    /* config */
  });
  viewerInstance.value = viewer;

  viewer.ready.then(() => {
    // 等待 Vue 3 渲染完成，确保 annotationDialog.value 可用
    nextTick(() => {
      if (annotationDialog.value) {
        // 定义 props 回调 (可选)
        const handleAnnotationProps = (slotProps) => {
          console.log("Annotation slot received props:", slotProps);
          // 可以根据 slotProps 决定是否显示或更新内容
          // if (slotProps.visible) {
          //     annotationDialog.value.style.display = '';
          // } else {
          //     annotationDialog.value.style.display = 'none';
          // }
        };

        // 设置插槽内容
        viewer.setSlotContent(
          "annotationInput", // 插槽名称
          annotationDialog.value, // 隐藏的 DOM 元素
          handleAnnotationProps // 处理 props 的回调
        );

        // 如果没有 propsCallback，可以只传两个参数：
        // viewer.setSlotContent("anotherSlot", anotherElement);

        // 清空插槽：
        // viewer.setSlotContent("annotationInput", null);
      }
    });
  });
});
</script>

<template>
  <div ref="viewerContainer" style="width: 800px; height: 600px;"></div>

  <!-- Vue 3 模板，初始会被渲染但会被 JS 隐藏 -->
  <div ref="annotationDialog">
    <h3>动态 Vue 3 插槽内容</h3>
    <!-- ... 您的 Vue 3 UI ... -->
  </div>
</template>
```

## 9. 处理事件 (`on`)

`BimViewer` 允许您监听由内部 `pit-bim-win-ui` 组件触发的事件。

- **`viewer.on(eventName, callback)`**

  - `eventName` (string): 要监听的事件名称。**注意:** 具体的事件名称取决于 `pit-bim-win-ui` 组件的实现。请查阅 PIT SDK 文档或使用浏览器开发者工具查看实际触发的事件。常见示例可能包括：`'model-loaded'`, `'select-changed'`, `'measurement-added'`, `'tag-clicked'` 等。
  - `callback` (function): 事件触发时调用的回调函数，会接收到 `pit-bim-win-ui` 传递的事件参数。
  - 返回 `viewer` 实例，支持链式调用。
**示例:**

```javascript
viewer.ready.then(() => {
  const onModelLoaded = (loadTime) => {
    console.log(`模型加载完成，耗时: ${loadTime}`);
  };

  viewer.on("onModelLoaded", onModelLoaded);
});
```

## 10. 资源清理 (`destroy`)

当您不再需要 `BimViewer` 实例时（例如，用户离开页面或关闭相关功能），**务必**调用 `destroy` 方法来释放资源，避免内存泄漏。

- **`viewer.destroy()`**
  - 销毁主视图的内部 Vue 实例。
  - 销毁所有通过 `showDialog` 创建且仍然存在的对话框实例。
  - 移除所有通过 `on` 方法添加的事件监听器。
  - 清空内部引用（如 DOM 目标、配置等）。
  - 调用后，`BimViewer` 实例将不可用。

**示例:**

```javascript
// 在组件卸载或页面关闭前调用
window.addEventListener("beforeunload", () => {
  if (viewer) {
    viewer.destroy();
    console.log("BimViewer instance destroyed.");
  }
});

// 或者在 SPA (单页应用) 的组件销毁钩子中调用
// (React useEffect cleanup, Vue beforeDestroy/unmounted, Angular ngOnDestroy)
// useEffect(() => {
//     const viewer = new BimViewer(...);
//     // ... setup ...
//     return () => { // Cleanup function
//         viewer.destroy();
//     };
// }, []);
```

## 11. 注意事项

- **CSS 作用域:** 如果您注入的插槽内容或对话框内容需要特定的 CSS 样式，请确保这些样式能够正确应用。如果您的主应用使用了 CSS Modules 或 Scoped CSS，可能需要使用全局样式或特定的 CSS 注入策略。
- **错误处理:** `BimViewer` 在初始化和方法调用中会进行一些基本的错误检查并在控制台输出错误/警告。建议在 `viewer.ready` 的 `.catch()` 中添加健壮的错误处理逻辑，并根据需要在使用其他 API 时添加 `try...catch`。
- **`pit-bim-win-ui` 事件:** 本文档只列举了可能的事件名称示例。请务必参考前端文档或使用开发工具来确定 `pit-bim-win-ui` 实际支持的事件及其参数。
